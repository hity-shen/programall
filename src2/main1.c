/*
 * main1.c
 *
 * created: 2022/7/14
 *  author: 
 */

#include "main1.h"

int main(void)
{
	SYS_Init();//?米赤33?那??‘℅邦o‘那y
	MPU_Mode();//?米赤31∟℅‾?㏒那?????
	while(1)   //?‾?-?﹞
	{
		MPU_Read();    //MPU6050那y?Y?芍豕?
		DATA_Report(); //MPU6050那y?Y谷?㊣“
	}
}

void SYS_Init(void)
{
	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);  //?D??車??豕??﹞?℅谷o‘那y
	delay_init();	    							 //?車那㊣o‘那y3?那??‘
	uart_init(115200);	 	                         //∩??迆3?那??‘?a115200
	LED_Init();		                               	 //3?那??‘車?LED芍??車米?車2?t?車?迆
	KEY_Init();                                      //∼∩?邦3?那??‘
	Lcd_Init();                                      //??那??芍3?那??‘
	Lcd_Clear(GRAY0);                                //?芍??3?那??‘?a?辰谷?
	Gui_DrawFont_GBK16(4,30,BLACK,GRAY0,"MPU6050那y?Y2谷?‘");//??℅???那?
	LCD_LED_SET;									 //?a???芍??㊣31a


	MPU_Init();	                                     //3?那??‘MPU6050
	while(mpu_dmp_init())                            //3?那??‘mpu_dmp?a
 	{
		Gui_DrawFont_GBK16(20,62,RED,GRAY0,"3?那??‘那∫∼邦!");//??℅???那?
		LED1 = !LED1;delay_ms(50);LED1 = !LED1;     //LED谷芍????那?
		Gui_DrawFont_GBK16(20,62,GRAY0,GRAY0,"3?那??‘那∫∼邦!");//??℅???那?
		printf("Initialization failed㏒?\r\n");		//∩??迆3?那??‘那∫∼邦谷?㊣“
	}
	printf("Initialization succeed㏒?\r\n");			//∩??迆3?那??‘3谷1|谷?㊣“
	Gui_DrawFont_GBK16(20,62,RED,GRAY0,"3?那??‘3谷1|!");delay_ms(200);Gui_DrawFont_GBK16(20,62,GRAY0,GRAY0,"3?那??‘3谷1|!");delay_ms(200);Gui_DrawFont_GBK16(20,62,RED,GRAY0,"3?那??‘3谷1|!");delay_ms(200);Gui_DrawFont_GBK16(20,62,GRAY0,GRAY0,"3?那??‘3谷1|!");delay_ms(200);Gui_DrawFont_GBK16(20,62,RED,GRAY0,"3?那??‘3谷1|!");//3?那??‘3谷1|那㊣谷芍??豕y∩?
	LED2 = !LED2;delay_ms(50);LED2 = !LED2;		//LED谷芍????那?
	delay_ms(999);									//?車那㊣3???????那?
	mpu6050.flag = 0;                               //2谷?‘3谷1|㊣那????3?那??‘
	mpu6050.speed = 0;								//谷?㊣“?迄?豕3?那??‘
	mpu6050.mode = 255;								//1∟℅‾?㏒那?3?那??‘
	key = 255;										//∼∩?邦?米3?那??‘
}
/**
  * @brief  ?米赤31∟℅‾?㏒那?????o‘那y
  * @param  ?T
  * @retval ?T
  */
void MPU_Mode(void)
{
	Lcd_Clear(GRAY0);							    //?芍??3?那??‘?a?辰谷?
	Gui_DrawFont_GBK16(24,16,BLUE,GRAY0,"?㏒那??????");//??℅???那?
	Gui_DrawFont_GBK16(12,60,BLUE,GRAY0,"KEY0:那米那㊣那y?Y");//??℅???那?
	Gui_DrawFont_GBK16(12,80,BLUE,GRAY0,"KEY1:?㏒?a???芍");//??℅???那?
	Gui_DrawFont_GBK16(12,100,BLUE,GRAY0,"WK_UP:﹞米??");//??℅???那?
	while(1)//?-?﹞
	{
		key = KEY_Scan(0);//∼∩?邦谷“?豕
		if(key == KEY0_PRES)//KEY0∩ㄓ﹞⊿
		{
			mpu6050.mode = 1;//1∟℅‾?㏒那?谷豕???a1
			uart_init(115200);//3?那??‘∩??迆
			Lcd_Clear(GRAY0);//?芍??3?那??‘?a?辰谷?
			Gui_DrawFont_GBK16(32,16,BLACK,GRAY0,"那米那㊣那y?Y");
			Gui_DrawFont_GBK16(8,40,BLUE,GRAY0,"??????:      ??");//??℅???那?
			Gui_DrawFont_GBK16(8,60,BLUE,GRAY0,"??o???:      ??");//??℅???那?
			Gui_DrawFont_GBK16(8,80,BLUE,GRAY0,"﹞-1???:      ??");//??℅???那?
			Gui_DrawFont_GBK16(8,100,RED,GRAY0,"???豕?米:      ??");//??℅???那?
			goto X;//足?℅a米?3??迆
		}
		else if(key == KEY1_PRES)//KEY1∩ㄓ﹞⊿
		{
			mpu6050.mode = 2;//1∟℅‾?㏒那?谷豕???a2
			uart_init(500000);//3?那??‘∩??迆
			Lcd_Clear(GRAY0);//?芍??3?那??‘?a?辰谷?
			Gui_DrawFont_GBK16(32,16,BLACK,GRAY0,"?㏒?a???芍");//??℅???那?
			Gui_DrawFont_GBK16(28,60,RED,GRAY0,"谷?∩??D...");//??℅???那?

			goto X;//足?℅a米?3??迆
		}
		else ;//﹞角?“?角
		delay_ms(10);//谷“?豕∼∩?邦?車那㊣
	}
	X:;//3??迆
}
/**
  * @brief  MPU6050那y?Y?芍豕?o‘那y
  * @param  ?T
  * @retval ?T
  */
void MPU_Read(void)
{

	if(mpu_dmp_get_data(&pitch,&roll,&yaw)==0)//dmp∩|角赤米?米?那y?Y㏒???﹞米???米??DD?D??
	{
		temp=MPU_Get_Temperature();	                //米?米????豕?米
		MPU_Get_Accelerometer(&aacx,&aacy,&aacz);	//米?米??車?迄?豕∩??D?‾那y?Y
		MPU_Get_Gyroscope(&gyrox,&gyroy,&gyroz);	//米?米?赤車?Y辰?那y?Y
		mpu6050.speed++;                            //谷?㊣“?迄?豕℅??車
		if(mpu6050.speed == 1)						//谷?㊣“?迄?豕?D?米谷豕??
		{
			mpu6050.flag = 1;						//谷?㊣“㊣那?????a車DD∫
			mpu6050.speed = 0;						//谷?㊣“?迄?豕1谷芍?
		}
	}
	else 											//2谷?‘2?3谷1|
	{
		mpu6050.flag = 0;							//谷?㊣“㊣那?????a?TD∫
	}
}

void DATA_Report(void)
{
	if(mpu6050.mode==1)								//??豕?1∟℅‾?㏒那?1
	{
		if(mpu6050.flag == 1)						//谷?㊣“㊣那?????a車DD∫
		{
			if(temp<0)								//??那y?Y?y?o?D??㏒??D???a?o那㊣
			{
				temp=-temp;							//???o那y?Y豕?﹞∩
				sprintf(tmp_buf, "-%3d.%d",temp/100,temp%10);//℅?﹞?∩???那??‘?邦芍?
				Gui_DrawFont_GBK16(64,100,RED,GRAY0,(u8*)tmp_buf);//LCD??那?16o?∩車D?℅?﹞?∩?
			}
			else                                    //?D???a?y那㊣
			{
				sprintf(tmp_buf, " %3d.%d",temp/100,temp%10);//℅?﹞?∩???那??‘?邦芍?
				Gui_DrawFont_GBK16(64,100,RED,GRAY0,(u8*)tmp_buf);//LCD??那?16o?∩車D?℅?﹞?∩?
			}
			printf("temp:%d.%d,  ",temp/100,temp%10); //赤“1y∩??迆1那?3????豕

			temp=pitch*10;							 //?3temp?apitch
			if(temp<0)								//??那y?Y?y?o?D??㏒??D???a?o那㊣
			{
				temp=-temp;						    //???o那y?Y豕?﹞∩
				sprintf(tmp_buf, "-%3d.%d",temp/10,temp%10);//℅?﹞?∩???那??‘?邦芍?
				Gui_DrawFont_GBK16(64,40,BLUE,GRAY0,(u8*)tmp_buf);//LCD??那?16o?∩車D?℅?﹞?∩?
			}
			else                                    //?D???a?y那㊣
			{
				sprintf(tmp_buf, " %3d.%d",temp/10,temp%10);//℅?﹞?∩???那??‘?邦芍?
				Gui_DrawFont_GBK16(64,40,BLUE,GRAY0,(u8*)tmp_buf);//LCD??那?16o?∩車D?℅?﹞?∩?
			}
			printf("pitch:%d.%d,  ",temp/10,temp%10); //赤“1y∩??迆1那?3?pitch

			temp=yaw*10;                           //?3temp?ayaw
			if(temp<0)								//??那y?Y?y?o?D??㏒??D???a?o那㊣
			{
				temp=-temp;						    //???o那y?Y豕?﹞∩
				sprintf(tmp_buf, "-%3d.%d",temp/10,temp%10);//℅?﹞?∩???那??‘?邦芍?
				Gui_DrawFont_GBK16(64,60,BLUE,GRAY0,(u8*)tmp_buf);//LCD??那?16o?∩車D?℅?﹞?∩?
			}
			else                                    //?D???a?y那㊣
			{
				sprintf(tmp_buf, " %3d.%d",temp/10,temp%10);//℅?﹞?∩???那??‘?邦芍?
				Gui_DrawFont_GBK16(64,60,BLUE,GRAY0,(u8*)tmp_buf);//LCD??那?16o?∩車D?℅?﹞?∩?
			}
			printf("yaw:%d.%d,  ",temp/10,temp%10);//赤“1y∩??迆1那?3?yaw

			temp=roll*10;                            //?3temp?aroll
			if(temp<0)								//??那y?Y?y?o?D??㏒??D???a?o那㊣
			{
				temp=-temp;						    //???o那y?Y豕?﹞∩
				sprintf(tmp_buf, "-%3d.%d",temp/10,temp%10);//℅?﹞?∩???那??‘?邦芍?
				Gui_DrawFont_GBK16(64,80,BLUE,GRAY0,(u8*)tmp_buf);//LCD??那?16o?∩車D?℅?﹞?∩?
			}
			else                                    //?D???a?y那㊣
			{
				sprintf(tmp_buf, " %3d.%d",temp/10,temp%10);//℅?﹞?∩???那??‘?邦芍?
				Gui_DrawFont_GBK16(64,80,BLUE,GRAY0,(u8*)tmp_buf);//LCD??那?16o?∩車D?℅?﹞?∩?
			}
			printf("roll:%d.%d,  ",temp/10,temp%10);//赤“1y∩??迆1那?3?roll
			printf("gyrox:%5d,  gyroy:%5d,  gyroz:%5d,  aacx:%5d,  aacy:%5d,  aacz:%5d\r\n",gyrox,gyroy,gyroz,aacx,aacy,aacz);//谷?㊣“???迄?豕那y?Y㏒????車?迄?豕那y?Y

			LED2=!LED2;								 			//LED谷芍??
			key = KEY_Scan(0);	                      			//∼∩?邦谷“?豕
			if(key == WKUP_PRES)                     			//∼∩?邦?米?aWK_UP那㊣
			{
				mpu6050.flag = 0;                               //谷?㊣“㊣那????3?那??‘
				mpu6050.speed = 0;								//谷?㊣“?迄?豕3?那??‘
				mpu6050.mode = 255;								//1∟℅‾?㏒那?3?那??‘
				key = 255;										//∼∩?邦?米3?那??‘
				MPU_Mode();										//??豕??㏒那?????
			}
			mpu6050.flag = 0;									//谷?㊣“㊣那????谷豕???a?TD∫
		}
	}
	else if(mpu6050.mode==2)									//??豕?1∟℅‾?㏒那?2
	{
		if(mpu6050.flag == 1)									//谷?㊣“㊣那?????a車DD∫
		{
			mpu6050_send_data(aacx,aacy,aacz,gyrox,gyroy,gyroz);//﹞⊿?赤?車?迄?豕∩??D?‾那y?Yo赤赤車?Y辰?那y?Y
			usart1_report_imu(aacx,aacy,aacz,gyrox,gyroy,gyroz,(int)(roll*100),(int)(pitch*100),(int)(yaw*10));//谷?㊣“?芍??o車米?℅?足?那y?Y
			key = KEY_Scan(0);									//∼∩?邦谷“?豕
			if(key == WKUP_PRES)                     			//∼∩?邦?米?aWK_UP那㊣
			{
				mpu6050.flag = 0;                               //谷?㊣“㊣那????3?那??‘
				mpu6050.speed = 0;								//谷?㊣“?迄?豕3?那??‘
				mpu6050.mode = 255;								//1∟℅‾?㏒那?3?那??‘
				key = 255;										//∼∩?邦?米3?那??‘
				MPU_Mode();										//??豕??㏒那?????
			}
			mpu6050.flag = 0;									//谷?㊣“㊣那????谷豕???a?TD∫
		}
	}
	else ;														//﹞角?“?角
}

